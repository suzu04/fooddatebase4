<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ãŠæ°—ã«å…¥ã‚Š</title>
</head>

<body>

    <header>
        <h1>ãŠæ°—ã«å…¥ã‚Š</h1>
        <a href="/">ğŸ”™ æˆ»ã‚‹</a>
    </header>

    <main>
        <p style="text-align:left;">ãŠæ°—ã«å…¥ã‚Šç™»éŒ²ã—ãŸé£Ÿå“ã ã‘ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>

        <div class="controls">
            <button id="resetStars" class="button">â­ ãƒªã‚»ãƒƒãƒˆï¼ˆé¸æŠä¸­ <span id="compare-count">0</span> ä»¶ï¼‰</button>
            <button id="pfcCompare" class="button">ğŸ“Š PFCæ¯”è¼ƒã¸</button>
            <button id="group" class="button">ã‚°ãƒ«ãƒ¼ãƒ—åŒ–</button>
            <button class="button" onclick="location.href='/group-create'">ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ä¸€è¦§</button>
        </div>

        <!-- ===== ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
        <div id="groupModal" class="modal">
            <div class="modal-content">
                <h3>ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ</h3>
                <p id="selectedCount">é¸æŠä¸­ï¼š0ä»¶</p>
                <input type="text" id="groupName" placeholder="ã‚°ãƒ«ãƒ¼ãƒ—åï¼ˆä¾‹ï¼šç©€ç‰©ã‚»ãƒƒãƒˆï¼‰" />
                <div class="modal-actions">
                    <button id="saveGroupBtn" class="button">ä¿å­˜</button>
                    <button id="cancelGroupBtn" class="button gray">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </div>
        </div>

        <style>
            body {
                font-family: 'Noto Sans JP', sans-serif;
                background: #f8fafc;
                color: #333;
            }

            header {
                text-align: center;
                padding: 15px 0;
                background: #2f855a;
                color: white;
            }

            table {
                width: 90%;
                margin: 20px auto;
                border-collapse: collapse;
                max-height: 300px;
                display: block;
                overflow-y: auto;
            }

            th,
            td {
                border: 1px solid #ccc;
                padding: 8px;
                text-align: center;
            }

            th {
                background: #e2f0d9;
            }

            tbody tr:hover {
                background: #f0f0f0;
            }

            .fav {
                cursor: pointer;
                font-size: 1.2em;
            }

            .modal {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.4);
                justify-content: center;
                align-items: center;
                z-index: 1000;
            }

            .modal-content {
                background: #fff;
                padding: 20px;
                width: 300px;
                border-radius: 12px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
                text-align: center;
            }

            .modal-content input {
                width: 100%;
                padding: 8px;
                margin: 10px 0;
                border-radius: 6px;
                border: 1px solid #ccc;
            }

            .modal-actions {
                display: flex;
                justify-content: space-between;
                margin-top: 15px;
            }

            .button.gray {
                background: #9ca3af;
            }
        </style>
    </main>

    <table id="favorites-table">
        <thead>
            <tr>
                <th>ã‚°ãƒ«ãƒ¼ãƒ—</th>
                <th>ç•ªå·</th>
                <th>é£Ÿå“å</th>
                <th>ã‚¨ãƒãƒ«ã‚®ãƒ¼(kcal)</th>
                <th>ãŸã‚“ã±ãè³ª(g)</th>
                <th>è„‚è³ª(g)</th>
                <th>ç‚­æ°´åŒ–ç‰©(g)</th>
                <th>ãŠæ°—ã«å…¥ã‚Š</th>
            </tr>
        </thead>
        <tbody>
            {% for row in rows %}
            <tr class="food-row" data-id="{{ row[1] }}">
                <td>{{ row[0] }}</td>
                <td>{{ row[1] }}</td>
                <td>{{ row[2] }}</td>
                <td>{{ row[3] }}</td>
                <td>{{ row[4] }}</td>
                <td>{{ row[5] }}</td>
                <td>{{ row[6] }}</td>
                <td class="fav" data-id="{{ row[1] }}">â˜†</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script src="{{ url_for('static', filename='favorite.js') }}" defer></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const favIds = JSON.parse(localStorage.getItem("favorites") || "[]");
            let count = 0;

            document.querySelectorAll("#favorites-table tbody tr.food-row").forEach(row => {
                const id = row.dataset.id;

                if (!favIds.map(String).includes(id)) {
                    row.remove();
                } else {
                    row.querySelector(".fav").textContent = "â˜…";
                    count++;
                }
            });

            const compareCount = document.getElementById("compare-count");
            if (compareCount) compareCount.textContent = count;
        });
    </script>


    <script>
        const modal = document.getElementById("groupModal");
        const groupNameInput = document.getElementById("groupName");
        const selectedCount = document.getElementById("selectedCount");
        let groupMode = false;

        document.getElementById("group").addEventListener("click", () => {
            const table = document.getElementById("favorites-table");

            if (!groupMode) {
                groupMode = true;
                const headRow = table.querySelector("thead tr");
                const th = document.createElement("th");
                th.textContent = "é¸æŠ";
                headRow.insertBefore(th, headRow.firstChild);

                table.querySelectorAll("tbody tr").forEach(tr => {
                    const td = document.createElement("td");
                    td.innerHTML = `<input type="checkbox" class="group-select" id="${tr.dataset.id}">`;
                    tr.insertBefore(td, tr.firstChild);
                });

                document.getElementById("group").textContent = "ã‚°ãƒ«ãƒ¼ãƒ—ä¿å­˜";
                return;
            }

            const selected = document.querySelectorAll(".group-select:checked");
            if (selected.length === 0) {
                alert("é£Ÿå“ã‚’é¸æŠã—ã¦ãã ã•ã„");
                return;
            }

            selectedCount.textContent = `é¸æŠä¸­ï¼š${selected.length}ä»¶`;
            modal.style.display = "flex";
        });

        document.getElementById("cancelGroupBtn").onclick = () => {
            modal.style.display = "none";
            groupNameInput.value = "";
        };

        document.getElementById("saveGroupBtn").onclick = () => {
            const name = groupNameInput.value.trim();
            if (!name) {
                alert("ã‚°ãƒ«ãƒ¼ãƒ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }

            const ids = Array.from(document.querySelectorAll(".group-select:checked")).map(c => c.dataset.id);
            const groups = JSON.parse(localStorage.getItem("groups") || "[]");

            groups.push({
                id: "grp_" + Date.now(),
                name,
                items: ids
            });

            localStorage.setItem("groups", JSON.stringify(groups));
            alert("ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
            modal.style.display = "none";
            groupNameInput.value = "";
        };
    </script>

</body>

</html>